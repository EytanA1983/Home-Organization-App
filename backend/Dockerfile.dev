# syntax=docker/dockerfile:1.4
# ==================== Backend Development Dockerfile ====================
# Full development environment with hot reload
# Image size: ~500MB (includes dev dependencies)
#
# Features:
# - BuildKit cache mounts for faster rebuilds
# - All dev dependencies included
# - Hot reload enabled
#
# Build:
#   DOCKER_BUILDKIT=1 docker build -f Dockerfile.dev -t backend-dev .

FROM python:3.12-slim

# Build arguments
ARG POETRY_VERSION=1.7.1

# Environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    POETRY_NO_INTERACTION=1 \
    POETRY_VIRTUALENVS_CREATE=false \
    POETRY_HOME="/opt/poetry" \
    POETRY_CACHE_DIR="/root/.cache/pypoetry" \
    PYTHONPATH=/app

ENV PATH="$POETRY_HOME/bin:$PATH"

# Install system dependencies with cache mount
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    libpq-dev \
    curl \
    git \
    # Debug tools
    vim \
    htop

# Install Poetry with cache mount
RUN --mount=type=cache,target=/root/.cache/pip \
    curl -sSL https://install.python-poetry.org | python3 - --version ${POETRY_VERSION}

WORKDIR /app

# Copy dependency files
COPY pyproject.toml poetry.lock ./

# Install ALL dependencies (including dev) with cache mounts
RUN --mount=type=cache,target=/root/.cache/pip \
    --mount=type=cache,target=/root/.cache/pypoetry \
    poetry install --no-root --no-ansi

# Copy application code (will be overwritten by volume mount)
COPY . .

# Create non-root user for development
RUN useradd -m -s /bin/bash devuser \
    && chown -R devuser:devuser /app

# Don't switch to non-root in dev (for easier debugging)
# USER devuser

EXPOSE 8000

# Development command with hot reload
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
