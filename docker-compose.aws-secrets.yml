# ==================== Docker Compose with AWS Secrets Manager ====================
# Production configuration using AWS Secrets Manager
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.aws-secrets.yml up -d
#
# Prerequisites:
#   1. AWS credentials configured (IAM role, env vars, or ~/.aws/credentials)
#   2. Secrets stored in AWS Secrets Manager at: eli-maor/production
#
# Create secrets in AWS:
#   aws secretsmanager create-secret \
#     --name eli-maor/production \
#     --secret-string '{"SECRET_KEY":"xxx","DATABASE_URL":"xxx",...}'

version: "3.9"

services:
  # ==================== Backend with AWS Secrets ====================
  backend:
    environment:
      # AWS Secrets Manager configuration
      - AWS_SECRET_NAME=eli-maor/production
      - AWS_REGION=${AWS_REGION:-us-east-1}

      # AWS credentials (prefer IAM roles in production)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}

      # Or use IAM role (ECS/EKS)
      # - AWS_CONTAINER_CREDENTIALS_RELATIVE_URI

      # Clear direct env vars (will be read from AWS)
      - SECRET_KEY=
      - GOOGLE_CLIENT_ID=
      - GOOGLE_CLIENT_SECRET=
      - VAPID_PUBLIC_KEY=
      - VAPID_PRIVATE_KEY=

  # ==================== Worker with AWS Secrets ====================
  worker:
    environment:
      - AWS_SECRET_NAME=eli-maor/production
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}

  # ==================== Beat with AWS Secrets ====================
  beat:
    environment:
      - AWS_SECRET_NAME=eli-maor/production
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
