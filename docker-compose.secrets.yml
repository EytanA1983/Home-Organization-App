# ==================== Docker Compose with Secrets ====================
# Production configuration using Docker secrets
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.secrets.yml up -d
#
# Create secrets first:
#   echo "your-secret-key" | docker secret create secret_key -
#   echo "your-db-password" | docker secret create db_password -
#   echo "your-google-client-secret" | docker secret create google_client_secret -
#   echo "your-vapid-private-key" | docker secret create vapid_private_key -
#
# Or use files:
#   docker secret create secret_key ./secrets/secret_key.txt
#
# For Docker Compose (non-swarm), secrets are read from files in ./secrets/

version: "3.9"

# ==================== Secrets Definition ====================
secrets:
  # Database credentials
  db_password:
    file: ./secrets/db_password.txt

  # Application secrets
  secret_key:
    file: ./secrets/secret_key.txt

  # Google OAuth
  google_client_id:
    file: ./secrets/google_client_id.txt
  google_client_secret:
    file: ./secrets/google_client_secret.txt

  # VAPID keys for push notifications
  vapid_public_key:
    file: ./secrets/vapid_public_key.txt
  vapid_private_key:
    file: ./secrets/vapid_private_key.txt

  # Optional: OpenAI API key
  # openai_api_key:
  #   file: ./secrets/openai_api_key.txt

  # Optional: Mail password
  # mail_password:
  #   file: ./secrets/mail_password.txt

services:
  # ==================== Database ====================
  db:
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_password

  # ==================== Backend ====================
  backend:
    secrets:
      - secret_key
      - db_password
      - google_client_id
      - google_client_secret
      - vapid_public_key
      - vapid_private_key
    environment:
      # Override environment variables to use secrets
      - SECRET_KEY_FILE=/run/secrets/secret_key
      - GOOGLE_CLIENT_ID_FILE=/run/secrets/google_client_id
      - GOOGLE_CLIENT_SECRET_FILE=/run/secrets/google_client_secret
      - VAPID_PUBLIC_KEY_FILE=/run/secrets/vapid_public_key
      - VAPID_PRIVATE_KEY_FILE=/run/secrets/vapid_private_key
      # Tell app to read from Docker secrets
      - USE_DOCKER_SECRETS=true

  # ==================== Worker ====================
  worker:
    secrets:
      - secret_key
      - db_password
      - google_client_id
      - google_client_secret
    environment:
      - USE_DOCKER_SECRETS=true

  # ==================== Beat ====================
  beat:
    secrets:
      - secret_key
      - db_password
    environment:
      - USE_DOCKER_SECRETS=true
